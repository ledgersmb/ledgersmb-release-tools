

root-password password:root
hostname releaser.local
run-command fstrim -a -v
run-command DEBIAN_FRONTEND=noninteractive dpkg-reconfigure grub-pc

copy-in ./files/00recommended:/etc/apt/apt.conf.d/

run-command apt-get -y --allow-releaseinfo-change update
run-command DEBIAN_FRONTEND=noninteractive apt-get dist-upgrade -q -y -o Dpkg::Options::=--force-confnew

install curl,dhcpcd5,openssh-server,openssh-client,gnupg2,git,make,gcc,cpanminus,graphviz,libdbi-perl,libdbd-pg-perl,postgresql-autodoc,python3-pip,python3-setuptools,python3-wheel,python3-urllib3,tar,gzip,gettext,lsb-release,jq,coreutils,apt-transport-https,ksh,sudo,avahi-daemon,dirmngr,libvirt-daemon,libvirt-clients,libguestfs-tools,qemu-kvm,qemu-utils,libmediawiki-api-perl,libdata-uuid-perl,libxml-simple-perl,libclass-factory-perl,libclass-accessor-perl,liblog-log4perl-perl,libfile-slurp-perl,libexception-class-perl,libdatetime-format-strptime-perl,libmoose-perl,libtemplate-perl,libreadonly-perl,libmime-tools-perl,libemail-sender-perl,libemail-stuffer-perl,libauthen-sasl-perl,libc6-dev,g++,libc++-dev,transifex-client,uuid
copy-in ./files/motd:/etc/


run-command pip3 install --upgrade urllib3
run-command pip3 install matrix-client


# Net::Async::Matrix for the matrix announcement
run-command cpanm --notest Pod::ProjectDocs Workflow Net::Async::Matrix MediaWiki::API

copy-in ./files/postgresql.list:/etc/apt/sources.list.d/
copy-in ./files/postgresql-key.asc:/etc/apt/trusted.gpg.d/
run-command apt-key add /etc/apt/trusted.gpg.d/postgresql-key.asc
copy-in ./files/nodesource.list:/etc/apt/sources.list.d/
copy-in ./files/nodesource.asc:/etc/apt/trusted.gpg.d/
run-command apt-key add /etc/apt/trusted.gpg.d/nodesource.asc
copy-in ./files/docker.list:/etc/apt/sources.list.d/
copy-in ./files/docker.asc:/etc/apt/trusted.gpg.d/
run-command apt-key add /etc/apt/trusted.gpg.d/docker.asc


update
install postgresql-13,nodejs,docker-ce

# Java JRE is required for building Dojo on 1.4 and 1.5
install default-jre-headless

# Uglify is required for building Dojo on 1.6 and 1.7
run-command npm install -g uglify-js@">=2.0 <3.0"

# 1.8+ use webpack to transpile JS, installed through npm at build time

append-line /etc/ssh/sshd_config:StreamLocalBindUnlink yes
edit /etc/sudoers: s/ALL$/NOPASSWD: ALL/

# make sure the dhcp deamon starts ; it fails when 'interfaces' exists
run-command rm /etc/network/interfaces
run-command adduser releaser ; \
            usermod -a -G kvm,docker,sudo releaser \
            mkdir /home/releaser/.ssh /home/releaser/.gnupg /home/releaser/bin
append-line /home/releaser/.bashrc:export NODE_PATH=/usr/lib/node_modules
copy-in ./files/mailer:/home/releaser/bin
copy-in ./tmp/authorized_keys:/home/releaser/.ssh
copy-in ./files/gnupg.conf:/home/releaser/.gnupg
upload ./tmp/gitconfig:/home/releaser/.gitconfig
upload ./files/ssh-config:/home/releaser/.ssh/config
upload ./tmp/dot-lsmb-release:/home/releaser/.lsmb-release
upload ./tmp/dot-lsmb-site-releases:/home/releaser/.lsmb-site-releases
upload ./tmp/dot-lsmb-github-releases:/home/releaser/.lsmb-github-releases
upload ./tmp/dot-lsmb-dockerhub-releases:/home/releaser/.lsmb-dockerhub-releases
upload ./tmp/dot-transifexrc:/home/releaser/.transifexrc

run-command \
   chown -R releaser:releaser /home/releaser/ ; \
   chmod -R u=rwX,go= /home/releaser/.ssh /home/releaser/.gnupg \
             /home/releaser/.lsmb-release /home/releaser/.lsmb-github-releases \
             /home/releaser/.lsmb-site-releases ; \
   chmod +x /home/releaser/bin/mailer

run-command \
   git clone https://github.com/cbbrowne/autodoc.git \
   cd autodoc \
   make install

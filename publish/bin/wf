#!/usr/bin/env perl

use v5.24;
use strict;
use warnings;
use utf8;

use FindBin qw($Bin);
use lib "$Bin/../lib";

use Getopt::Long;
use Log::Log4perl qw(:easy);
use Workflow;
use Workflow::Factory qw( FACTORY );

my $config_dir = "$Bin/../conf";

Log::Log4perl->easy_init($DEBUG);

FACTORY()->add_config_from_file(
    workflow => "$config_dir/workflow.xml",
    action => "$config_dir/actions.xml",
    condition => "$config_dir/conditions.xml",
    persister => "$config_dir/persister.xml",
    );


my $wf;
my $ctx = Workflow::Context->new();

sub wf_option {
    my ( $option, $value ) = @_;

    $ctx->param( $option => $value );
}

GetOptions(
    'force-tag' => \&wf_option,
    );

my ( $branch, $release, $uploader ) = @ARGV;
$ctx->param( branch   => $branch );
$ctx->param( release  => $release );
$ctx->param( uploader => $uploader );


$wf = FACTORY()->create_workflow( 'release', $ctx );

eval {
    $wf->execute_action( 'next' );
};
print "$@\n" if $@;

unless ($wf->state eq 'DONE') {
    say "Workflow didn't run to completion. Use " . $wf->id . " to restart";

    exit 1;
}


exit 0;
